function r(a,b){return i2c.writeTo(25,a),i2c.readFrom(25,b)}function w(a,b){i2c.writeTo(25,[a,b])}function accelPoll(e){var a=r(47,1)[0];if(a&64&&DBG('Overflow',a),a&=63,a>0){var b=6*a,d=r(40,b);if(e)for(var c=0;c<b;c+=6)d[c]|=1;accelSamples.set(d,accelSampleCount),accelSampleCount+=b,accelLastSampleCount=a,accelSampleCount>ACCEL_WRITE_LEVEL&&accelWriteData()}E.kickWatchdog()}function accelWriteData(a){if(sdWriteInProgress)return;sdWriteInProgress=!0,sdRunWithPowerOn(function(b){if(b){sdWriteInProgress=!1,accelSampleCount=0,a&&a(b);return}require('fs').appendFileSync(sdGetFileName(),new Uint8Array(accelSamples.buffer,0,accelSampleCount)),sdFileSize+=accelSampleCount,accelSampleCount=0,sdFileSize>=2147483648&&(sdFileSize=0,sdFileNumber++)},function(){sdWriteInProgress=!1,a&&a()})}function sdGetFileName(){return'acc'+sdFileNumber+'.raw'}function sdRunWithPowerOn(c,a){function d(){DBG('SD off'),E.unmountSD(),pinMode(SD.MISO,'input'),pinMode(SD.MOSI,'input'),pinMode(SD.SCK,'input'),pinMode(SD.CS,'input'),SD.PWR.set(),SD.MISO.reset(),SD.MOSI.reset(),SD.SCK.reset(),SD.CS.reset(),pinMode(SD.MISO,'output'),pinMode(SD.MOSI,'output'),pinMode(SD.SCK,'output'),pinMode(SD.CS,'output')}SD.PWR.reset(),SD.CS.set(),spi=SPI1,pinMode(SD.CS,'output'),pinMode(SD.MOSI,'output'),pinMode(SD.MISO,'input_pullup'),pinMode(SD.SCK,'output'),spi.setup({baud:4e6,mosi:SD.MOSI,miso:SD.MISO,sck:SD.SCK}),poke32(1342179072+SD.MOSI*4,771),poke32(1342179072+SD.SCK*4,771),poke32(1342179072+SD.MISO*4,12),DBG('SD on'),digitalPulse(LED,1,[10]);var b=4;sdPollInterval=setInterval(function(){if(b--,!b){digitalPulse(LED,1,[500]),clearInterval(sdPollInterval),sdPollInterval=undefined,DBG('SD connect failed.'),a&&a('ERROR'),d();return}DBG('SD connect attempt'),digitalPulse(LED,1,[10,100,10]),E.connectSDCard(spi,SD.CS);var e=getTime();try{c&&c(),clearInterval(sdPollInterval),sdPollInterval=undefined,setTimeout(function(){d(),a&&a()},200)}catch(a){DBG(a)}DBG(getTime()-e,'seconds')},100)}function getLastData(){var a=new DataView(accelSamples.buffer),b=accelSampleCount-6;print(a.getInt16(b,1),a.getInt16(b+2,1),a.getInt16(b+4,1),a.getInt8(b)&1)}E.enableWatchdog(8,!0);var SD={PWR:D16,CS:D20,MISO:D17,MOSI:D19,SCK:D18},ACC={sda:D2,scl:D3,int0:D4,int1:D5},IO=[D7,D11,D12,D13],IO_STATE=D13,ACCEL_HZ=25,ACCEL_BUFFER_SAMPLES=2e4,ACCEL_WRITE_LEVEL=ACCEL_BUFFER_SAMPLES-6*Math.round(ACCEL_HZ)*10,ACCEL_INTERVAL=700,DBG=function(){};if(SD.PWR.set(),i2c=I2C1,i2c.setup({sda:ACC.sda,scl:ACC.scl,bitrate:1e9}),r(15,1)[0]!=68)throw'WHOAMI failed';w(33,64),w(33,128);while(r(33,1)[0]&128);if(ACCEL_HZ==12.5)w(32,34);else if(ACCEL_HZ==25)w(32,50);else throw'Unknown HZ';w(33,12),w(35,2),w(37,52),w(46,112);var sdPollInterval,sdFileNumber=0,sdFileSize=0,sdWriteInProgress=!1,accelPollInterval,accelSamples=new Uint8Array(ACCEL_BUFFER_SAMPLES),accelSampleCount=0,accelLastSampleCount;sdRunWithPowerOn(function(){require('fs').readdirSync().map(fn=>{if(!fn.startsWith('acc'))return;var a=fn.substr(3).split('.');if(a.length<2)return;var b=parseInt(a[0]);b>=sdFileNumber&&(sdFileNumber=b+1)})},function(a){a?setInterval(function(){LED.toggle()},500):(accelPollInterval=setInterval(function(){accelPoll(IO_STATE.read())},ACCEL_INTERVAL),pinMode(IO_STATE,'input_pulldown'),setWatch(function(a){accelPoll(!a.state)},IO_STATE,{repeat:!0}),digitalPulse(LED,1,[10,100,10]))}),NRF.getSecurityStatus().connected||NRF.sleep();var connectedInterval,connectedTimeout;setWatch(function(){if(digitalPulse(LED,1,[10,50,10,50,10,50,10]),!connectedInterval){try{NRF.wake()}catch(a){}connectedInterval=setInterval(function(){connectedTimeout--,connectedTimeout<=0?(clearInterval(connectedInterval),connectedInterval=undefined,NRF.sleep()):digitalPulse(LED,1,[10,50,10])},1e3)}connectedTimeout=60},BTN,{repeat:!0,debounce:1e3}),NRF.on('connect',function(){connectedInterval&&(clearInterval(connectedInterval),connectedInterval=undefined)}),NRF.on('disconnect',function(){connectedInterval&&(clearInterval(connectedInterval),connectedInterval=undefined),NRF.sleep()}),E.enableWatchdog(8,!1)